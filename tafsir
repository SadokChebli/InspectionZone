Le problème initial était triple. Premièrement, un conflit de variables d'environnement : Kubernetes injectait automatiquement une variable KAFKA_PORT (contenant une URL) à cause du nom du service "kafka", ce qui faisait crasher les scripts internes de l'image Confluent qui attendaient un simple nombre. Deuxièmement, une incompatibilité de bibliothèque client : la bibliothèque kafka-python ne parvenait pas à détecter automatiquement la version de l'API des brokers Kafka récents (7.4.0), déclenchant l'erreur fatale NoBrokersAvailable. Enfin, des problèmes de résolution DNS et de séquençage empêchaient les micro-services de trouver Kafka avant qu'il ne soit prêt.
Pour résoudre cela, nous avons renommé le service Kafka en kafka-svc pour supprimer la variable parasite, et utilisé un InitContainer (busybox) pour forcer les micro-services à attendre que le port 2181 de ZooKeeper soit ouvert. Nous avons également stabilisé Kafka en ajoutant des limites de mémoire RAM et en configurant correctement les ADVERTISED_LISTENERS. La solution finale a consisté à modifier le code source Python en forçant l'adresse DNS complète et en fixant manuellement la version du protocole via api_version=(3, 4, 0), ce qui a permis de rétablir immédiatement la connectivité entre les producteurs, les consommateurs et le broker.